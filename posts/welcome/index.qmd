---
title: "consulta de linhas de ônibus"
author: "Murilo Moraes"
date: "2025-11-21"
image: "pngtree-blue-bus-vektor-png-image_4938752.png"
categories: [programation]
jupyter: python3
---

neste post você vera como é um programa que consulta linhas de ônibus em uma mapa interativo! onde o codigo inteiro está explicado!


```{python}
import requests            # Biblioteca para fazer requisições HTTP
import folium              # Usada para criar mapas interativos e marcadores
import os                  # Usada para acessar variáveis de ambiente (como o token)
from dotenv import load_dotenv  # Carrega variáveis do arquivo .env

# ----------------------------------------------------------------------------
# 1. CARREGAMENTO DO TOKEN DA API
# ----------------------------------------------------------------------------

load_dotenv()  # Lê o arquivo .env e insere suas variáveis dentro de os.environ

TOKEN = os.getenv("SPTRANS_TOKEN")  
# Pegamos SOMENTE a variável do .env (conforme solicitado)
# Esta variável não pode ser renomeada para não quebrar a lógica do usuário

COD_LINHA = 1198

# Código da linha consultada. 

print(f"Iniciando consulta da linha {COD_LINHA}...")

# ----------------------------------------------------------------------------
# 2. AUTENTICAÇÃO NA API DO SPTRANS (Olho Vivo)
# ----------------------------------------------------------------------------

sessao = requests.Session()  
# Criamos uma sessão HTTP, que mantém cookies entre requisições

resposta_login = sessao.post(
    f"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={TOKEN}"
)
# A API exige um POST com o token na URL para autenticar a sessão

if resposta_login.text != "true":
    # A API retorna texto simples "true" se funcionar; qualquer outra coisa = erro
    print("Falha ao autenticar. Verifique o arquivo .env e o token informado.")
    exit()  # Encerra o programa imediatamente

# ----------------------------------------------------------------------------
# 3. MONTAGEM DAS URLS PARA CAPTURA DE PARADAS E POSIÇÃO DOS ÔNIBUS
# ----------------------------------------------------------------------------

url_coleta_paradas = (
    f"http://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={COD_LINHA}"
)
# Endpoint da API que devolve todas as paradas da linha consultada

url_coleta_veiculos = (
    f"http://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={COD_LINHA}"
)
# Endpoint que devolve a posição dos ônibus em tempo real

# ----------------------------------------------------------------------------
# 4. CONSULTA DOS DADOS NA API
# ----------------------------------------------------------------------------

dados_paradas = sessao.get(url_coleta_paradas).json()
# Lista de paradas contendo nome, lat, lon e infos extras

dados_posicoes = sessao.get(url_coleta_veiculos).json()
# Resultado bruto com várias informações, incluindo 'vs' que lista veículos

onibus_ativos = dados_posicoes.get("vs", [])
# "vs" = veículos → caso não exista, devolve lista vazia

# ----------------------------------------------------------------------------
# 5. GERAÇÃO DO MAPA INTERATIVO
# ----------------------------------------------------------------------------

if dados_paradas:
    # Se houver paradas encontradas...
    
    # --------------------------
    # CENTRALIZA O MAPA NA 1ª PARADA
    # --------------------------
    pos_inicial_lat = dados_paradas[0]["py"]  # Latitude da primeira parada
    pos_inicial_lon = dados_paradas[0]["px"]  # Longitude da primeira parada
    
    mapa = folium.Map(location=[pos_inicial_lat, pos_inicial_lon], zoom_start=13)
    # Cria o mapa centralizado na primeira parada da linha

    # --------------------------
    # INSERE TODAS AS PARADAS (MARCADOR AZUL)
    # --------------------------
    for parada in dados_paradas:
        folium.Marker(
            location=[parada["py"], parada["px"]],
            popup=f"Parada: {parada['np']}",  # 'np' é o nome da parada
            icon=folium.Icon(color="blue", icon="info-sign")
        ).add_to(mapa)

    # --------------------------
    # INSERE TODOS OS ÔNIBUS ATIVOS (MARCADOR VERMELHO)
    # --------------------------
    if onibus_ativos:
        for veiculo in onibus_ativos:
            folium.Marker(
                location=[veiculo["py"], veiculo["px"]],
                popup=f"Prefixo: {veiculo['p']}",  # 'p' = prefixo do ônibus
                icon=folium.Icon(color="red", icon="bus", prefix="fa")
            ).add_to(mapa)

        print(f"Mapa gerado com sucesso! {len(onibus_ativos)} ônibus encontrados.")
    else:
        print("Nenhum ônibus encontrado rodando no momento.")

    # --------------------------
    # SALVA O MAPA EM ARQUIVO HTML
    # --------------------------
    arquivo_saida = "mapa_linha_695Y.html"
    mapa.save(arquivo_saida)

    print(f"Arquivo '{arquivo_saida}' criado com sucesso!")

else:
    print("Erro ao carregar paradas da linha. A API pode estar instável.")

```
