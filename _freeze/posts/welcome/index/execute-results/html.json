{
  "hash": "61d2e017b28870c4722743bdc083cd2f",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"consulta de linhas de √¥nibus\"\nauthor: \"Murilo Moraes\"\ndate: \"2025-11-21\"\nimage: \"pngtree-blue-bus-vektor-png-image_4938752.png\"\ncategories: [programation]\njupyter: python3\n---\n\nneste post voc√™ vera como √© um programa que consulta linhas de √¥nibus em uma mapa interativo! onde o codigo inteiro est√° explicado!\n\n::: {#9b4a8dd6 .cell execution_count=1}\n``` {.python .cell-code}\nimport requests            # Biblioteca para fazer requisi√ß√µes HTTP\nimport folium              # Usada para criar mapas interativos e marcadores\nimport os                  # Usada para acessar vari√°veis de ambiente (como o token)\nfrom dotenv import load_dotenv  # Carrega vari√°veis do arquivo .env\n\n# ----------------------------------------------------------------------------\n# 1. CARREGAMENTO DO TOKEN DA API\n# ----------------------------------------------------------------------------\n\nload_dotenv()  # L√™ o arquivo .env e insere suas vari√°veis dentro de os.environ\n\nTOKEN = os.getenv(\"SPTRANS_TOKEN\")  \n# Pegamos SOMENTE a vari√°vel do .env (conforme solicitado)\n# Esta vari√°vel n√£o pode ser renomeada para n√£o quebrar a l√≥gica do usu√°rio\n\nCOD_LINHA = 1198\n\n# C√≥digo da linha consultada. \n\nprint(f\"Iniciando consulta da linha {COD_LINHA}...\")\n\n# ----------------------------------------------------------------------------\n# 2. AUTENTICA√á√ÉO NA API DO SPTRANS (Olho Vivo)\n# ----------------------------------------------------------------------------\n\nsessao = requests.Session()  \n# Criamos uma sess√£o HTTP, que mant√©m cookies entre requisi√ß√µes\n\nresposta_login = sessao.post(\n    f\"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={TOKEN}\"\n)\n# A API exige um POST com o token na URL para autenticar a sess√£o\n\nif resposta_login.text != \"true\":\n    # A API retorna texto simples \"true\" se funcionar; qualquer outra coisa = erro\n    print(\"Falha ao autenticar. Verifique o arquivo .env e o token informado.\")\n    exit()  # Encerra o programa imediatamente\n\n# ----------------------------------------------------------------------------\n# 3. MONTAGEM DAS URLS PARA CAPTURA DE PARADAS E POSI√á√ÉO DOS √îNIBUS\n# ----------------------------------------------------------------------------\n\nurl_coleta_paradas = (\n    f\"http://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={COD_LINHA}\"\n)\n# Endpoint da API que devolve todas as paradas da linha consultada\n\nurl_coleta_veiculos = (\n    f\"http://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={COD_LINHA}\"\n)\n# Endpoint que devolve a posi√ß√£o dos √¥nibus em tempo real\n\n# ----------------------------------------------------------------------------\n# 4. CONSULTA DOS DADOS NA API\n# ----------------------------------------------------------------------------\n\ndados_paradas = sessao.get(url_coleta_paradas).json()\n# Lista de paradas contendo nome, lat, lon e infos extras\n\ndados_posicoes = sessao.get(url_coleta_veiculos).json()\n# Resultado bruto com v√°rias informa√ß√µes, incluindo 'vs' que lista ve√≠culos\n\nonibus_ativos = dados_posicoes.get(\"vs\", [])\n# \"vs\" = ve√≠culos ‚Üí caso n√£o exista, devolve lista vazia\n\n# ----------------------------------------------------------------------------\n# 5. GERA√á√ÉO DO MAPA INTERATIVO\n# ----------------------------------------------------------------------------\n\nif dados_paradas:\n    # Se houver paradas encontradas...\n    \n    # --------------------------\n    # CENTRALIZA O MAPA NA 1¬™ PARADA\n    # --------------------------\n    pos_inicial_lat = dados_paradas[0][\"py\"]  # Latitude da primeira parada\n    pos_inicial_lon = dados_paradas[0][\"px\"]  # Longitude da primeira parada\n    \n    mapa = folium.Map(location=[pos_inicial_lat, pos_inicial_lon], zoom_start=13)\n    # Cria o mapa centralizado na primeira parada da linha\n\n    # --------------------------\n    # INSERE TODAS AS PARADAS (MARCADOR AZUL)\n    # --------------------------\n    for parada in dados_paradas:\n        folium.Marker(\n            location=[parada[\"py\"], parada[\"px\"]],\n            popup=f\"Parada: {parada['np']}\",  # 'np' √© o nome da parada\n            icon=folium.Icon(color=\"blue\", icon=\"info-sign\")\n        ).add_to(mapa)\n\n    # --------------------------\n    # INSERE TODOS OS √îNIBUS ATIVOS (MARCADOR VERMELHO)\n    # --------------------------\n    if onibus_ativos:\n        for veiculo in onibus_ativos:\n            folium.Marker(\n                location=[veiculo[\"py\"], veiculo[\"px\"]],\n                popup=f\"Prefixo: {veiculo['p']}\",  # 'p' = prefixo do √¥nibus\n                icon=folium.Icon(color=\"red\", icon=\"bus\", prefix=\"fa\")\n            ).add_to(mapa)\n\n        print(f\"Mapa gerado com sucesso! {len(onibus_ativos)} √¥nibus encontrados.\")\n    else:\n        print(\"Nenhum √¥nibus encontrado rodando no momento.\")\n\n    # --------------------------\n    # SALVA O MAPA EM ARQUIVO HTML\n    # --------------------------\n    arquivo_saida = \"mapa_linha_695Y.html\"\n    mapa.save(arquivo_saida)\n\n    print(f\"Arquivo '{arquivo_saida}' criado com sucesso!\")\n\nelse:\n    print(\"Erro ao carregar paradas da linha. A API pode estar inst√°vel.\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nIniciando consulta da linha 1198...\nNenhum √¥nibus encontrado rodando no momento.\nArquivo 'mapa_linha_695Y.html' criado com sucesso!\n```\n:::\n:::\n\n\n[üîó Abrir mapa interativo da linha 695Y](/static/mapa_linha_695Y.html)\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}